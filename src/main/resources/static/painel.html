<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Logística</title>
  
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/759/759739.png" type="image/png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      body.dark { background-color: #111827; color: #d1d5db; }
      body.dark .bg-white { background-color: #1f2937; border-color: #374151; }
      body.dark .text-gray-800, body.dark .text-gray-700, body.dark .text-slate-800 { color: #f3f4f6; }
      body.dark .text-gray-500, body.dark .text-slate-500 { color: #9ca3af; }
      body.dark .bg-gray-50, body.dark .bg-slate-50, body.dark .bg-transparent { background-color: #374151; color: #f3f4f6; }
      body.dark input.bg-transparent { background-color: transparent !important; }
      body.dark .border-b, body.dark .border-gray-200, body.dark .border-gray-100 { border-color: #374151; }
      body.dark .chartjs-legend-label, body.dark .chartjs-title { color: #f3f4f6 !important; }
  </style>

    <script>
      (function() {
          if (localStorage.theme === 'dark') {
              document.documentElement.classList.add('dark');
              document.body.classList.add('dark');
          } else {
              document.documentElement.classList.remove('dark');
              document.body.classList.remove('dark');
          }
      })();
  </script>

    <style>
      @keyframes fadeInPage {
          from { opacity: 0; transform: translateY(15px); }
          to   { opacity: 1; transform: translateY(0); }
      }
      body {
          animation: fadeInPage 0.5s ease-out forwards;
      }
      /* --- Animações do Toast --- */
      @keyframes slideInRight {
          from { opacity: 0; transform: translateX(100%); }
          to   { opacity: 1; transform: translateX(0); }
      }
      @keyframes slideOutRight {
          to { opacity: 0; transform: translateX(100%); }
      }
      .toast-in { animation: slideInRight 0.4s ease-out forwards; }
      .toast-out { animation: slideOutRight 0.4s ease-in forwards; }
      /* ------------------------- */
  </style>
  
  <script>
    const API_URL = "http://localhost:8080/api";
    let todosOsPedidos = []; 
    let filtroAtual = 'ATIVOS'; 
    let meuGrafico = null; 

    // --- NOVA FUNÇÃO: Cria as notificações ---
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        if (!container) return; 
        
        const toast = document.createElement('div');
        let bgColor, icon;

        if (type === 'success') {
            bgColor = 'bg-green-600';
            icon = '<i class="fa-solid fa-check-circle mr-3"></i>';
        } else if (type === 'error') {
            bgColor = 'bg-red-600';
            icon = '<i class="fa-solid fa-exclamation-triangle mr-3"></i>';
        } else { // info
            bgColor = 'bg-blue-600';
            icon = '<i class="fa-solid fa-info-circle mr-3"></i>';
        }

        toast.className = `flex items-center p-4 rounded-lg shadow-xl text-white ${bgColor} toast-in max-w-sm`;
        toast.innerHTML = `${icon}<span class="font-medium">${message}</span>`;
        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.remove('toast-in');
            toast.classList.add('toast-out');
            setTimeout(() => {
                toast.remove();
            }, 400); 
        }, 3000); 
    }
    // -------------------------------------

    function formatarDataHora(dataISO) {
        if (!dataISO) return "-";
        const data = new Date(dataISO);
        return data.toLocaleString('pt-BR', { 
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        });
    }

    // Carrega tudo ao iniciar a página (MODIFICADO)
    async function carregarPagina() {
      const nome = sessionStorage.getItem("nome");
      const role = sessionStorage.getItem("role");
      if (!nome) { 
          showToast("Sessão expirada. Faça login.", "error");
          setTimeout(() => { window.location.href = "index.html"; }, 1500); 
          return; 
      }

      document.getElementById("userName").textContent = nome;
      document.getElementById("userRole").textContent = role === "ROLE_ADMIN" ? "Administrador" : "Operador";

      if (role === "ROLE_ADMIN") {
          document.getElementById("adminControls").classList.remove("hidden");
      } else {
          document.getElementById("adminControls").classList.add("hidden");
      }
      
      const icon = document.getElementById('theme-icon');
      if (localStorage.theme === 'dark') {
          icon.classList.replace('fa-sun', 'fa-moon');
      } else {
          icon.classList.replace('fa-moon', 'fa-sun');
      }
      
      await carregarPedidosDoServidor(); 
      setInterval(carregarPedidosDoServidor, 5000); 
    }

    // Busca os dados da API e atualiza os cards/gráficos
    async function carregarPedidosDoServidor() {
      try {
        const res = await fetch(`${API_URL}/pedidos`);
        todosOsPedidos = await res.json(); 
        
        const total = todosOsPedidos.length;
        const entregues = todosOsPedidos.filter(p => p.status === "ENTREGUE").length;
        const pendentes = todosOsPedidos.filter(p => p.status === "PENDENTE" || p.status === "EM ROTA").length;

        document.getElementById("cardTotal").textContent = total;
        document.getElementById("cardEntregues").textContent = entregues;
        document.getElementById("cardPendentes").textContent = pendentes;

        atualizarGrafico(entregues, pendentes);
        renderizarTabela(); 
      
      } catch (e) { 
          console.error(e);
          // (Removido o toast de erro de API para não poluir a tela a cada 5s)
      }
    }

    // Desenha a tabela com base no filtro
    function renderizarTabela() {
        const role = sessionStorage.getItem("role");
        let pedidosFiltrados = [];

        if (filtroAtual === 'TODOS') {
            pedidosFiltrados = todosOsPedidos;
            document.getElementById("tituloTabela").textContent = "Histórico de Todos os Pedidos";
        } else if (filtroAtual === 'ENTREGUE') {
            pedidosFiltrados = todosOsPedidos.filter(p => p.status === 'ENTREGUE');
            document.getElementById("tituloTabela").textContent = "Pedidos Entregues";
        } else { // 'ATIVOS'
            pedidosFiltrados = todosOsPedidos.filter(p => p.status === 'PENDENTE' || p.status === 'EM ROTA');
            document.getElementById("tituloTabela").textContent = "Fila de Trabalho Ativa";
        }
        
        const tabela = document.getElementById("tabelaPedidos");
        tabela.innerHTML = ""; 

        pedidosFiltrados.forEach(p => {
          const row = document.createElement("tr");
          row.className = "border-b hover:bg-gray-50 transition";
          
          let statusClass, iconStatus, btnAcaoPrimaria = "", btnExcluir = "";

          if (p.status === "ENTREGUE") {
            statusClass = "bg-green-100 text-green-700 border-green-200";
            iconStatus = "fa-check-circle";
          } else if (p.status === "EM ROTA") {
            statusClass = "bg-blue-100 text-blue-700 border-blue-200";
            iconStatus = "fa-truck-fast";
          } else { // PENDENTE
            statusClass = "bg-yellow-100 text-yellow-700 border-yellow-200";
            iconStatus = "fa-clock";
          }

          if (p.status === "PENDENTE") {
              btnAcaoPrimaria = `<button onclick="mudarStatusEmRota(${p.id})" class="text-blue-500 hover:text-blue-700 mx-2" title="Marcar Em Rota"><i class="fa-solid fa-truck fa-lg"></i></button>`;
          } else if (p.status === "EM ROTA") {
              btnAcaoPrimaria = `<button onclick="mudarStatusEntregue(${p.id})" class="text-green-600 hover:text-green-800 mx-2" title="Marcar como Entregue"><i class="fa-solid fa-check-double fa-lg"></i></button>`;
          }
          
          if(role === "ROLE_ADMIN") {
              btnExcluir = `<button onclick="excluirPedido(${p.id})" class="text-red-400 hover:text-red-600 mx-2" title="Excluir"><i class="fa-solid fa-trash"></i></button>`;
          } else {
              btnExcluir = `<i class="fa-solid fa-lock text-gray-300 mx-2" title="Apenas Administradores"></i>`;
          }

          row.innerHTML = `
            <td class="p-4 font-mono text-blue-600 font-bold text-sm"><i class="fa-solid fa-barcode mr-2 text-gray-400"></i>${p.codigoRastreio || "..."}</td>
            <td class="p-4 font-medium text-gray-700">${p.nomeCliente}</td>
            <td class="p-4"><span class="${statusClass} px-3 py-1 rounded-full text-xs font-bold border flex items-center w-fit gap-2"><i class="fa-solid ${iconStatus}"></i> ${p.status}</span></td>
            <td class="p-4 text-gray-500 text-sm font-mono"><i class="fa-regular fa-clock mr-1"></i> ${formatarDataHora(p.dataPedido)}</td>
            <td class="p-4 text-center">${btnAcaoPrimaria} ${btnExcluir}</td>
          `;
          tabela.appendChild(row);
        });
    }

    // Função que os cards chamam para filtrar
    function aplicarFiltro(novoFiltro) {
        filtroAtual = novoFiltro; 
        renderizarTabela(); 
    }

    // --- Funções CRUD (MODIFICADAS) ---
    async function criarPedido() {
        const input = document.getElementById("novoCliente");
        if(!input.value) {
            showToast("Digite o nome do cliente.", "error");
            return;
        }
        await fetch(`${API_URL}/pedidos`, {
            method: "POST", headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ nomeCliente: input.value })
        });
        input.value = "";
        showToast("Pedido criado com sucesso!", "success");
        await carregarPedidosDoServidor(); 
    }

    async function mudarStatusEmRota(id) {
        if(!confirm("Enviar pedido para rota de entrega?")) return;
        await fetch(`${API_URL}/pedidos/${id}/em-rota`, { method: "PUT" });
        showToast("Pedido saiu para entrega (Em Rota).", "info");
        await carregarPedidosDoServidor(); 
    }
    
    async function mudarStatusEntregue(id) {
        if(!confirm("Confirmar entrega final do pedido?")) return;
        await fetch(`${API_URL}/pedidos/${id}/entregar`, { method: "PUT" });
        showToast("Pedido marcado como Entregue!", "success");
        await carregarPedidosDoServidor(); 
    }

    async function excluirPedido(id) {
        const role = sessionStorage.getItem("role");
        if (role !== "ROLE_ADMIN") {
            showToast("Acesso Negado: Apenas Admins podem excluir.", "error");
            return;
        }
        if(!confirm("Tem certeza que deseja excluir este pedido?")) return;
        await fetch(`${API_URL}/pedidos/${id}`, { method: "DELETE" });
        showToast("Pedido excluído com sucesso.", "success");
        await carregarPedidosDoServidor(); 
    }
    
    // Desenha o gráfico
    function atualizarGrafico(valorEntregues, valorPendentes) {
        const ctx = document.getElementById('graficoPedidos').getContext('2d');
        const isDark = document.body.classList.contains('dark');
        const textColor = isDark ? '#f3f4f6' : '#1f2937';
        
        const data = {
            labels: ['Entregues', 'Pendentes / Em Rota'],
            datasets: [{
                label: 'Volume de Pedidos',
                data: [valorEntregues, valorPendentes],
                backgroundColor: ['rgba(34, 197, 94, 0.7)', 'rgba(234, 179, 8, 0.7)'],
                borderColor: ['#16a34a', '#ca8a04'],
                borderWidth: 1
            }]
        };

        if (meuGrafico) {
            meuGrafico.data = data;
            meuGrafico.options.plugins.title.color = textColor;
            meuGrafico.options.plugins.legend.labels.color = textColor;
            meuGrafico.update();
        } else {
            meuGrafico = new Chart(ctx, {
                type: 'doughnut', data: data,
                options: {
                    responsive: true,
                    plugins: { 
                        legend: { position: 'top', labels: { color: textColor } }, 
                        title: { display: true, text: 'Distribuição de Status', color: textColor } 
                    }
                }
            });
        }
    }

    // Função que troca o tema
    function toggleTheme() {
        document.body.classList.toggle('dark');
        document.documentElement.classList.toggle('dark');
        
        const isDark = document.body.classList.contains('dark');
        localStorage.theme = isDark ? 'dark' : 'light';
        
        const icon = document.getElementById('theme-icon');
        if (isDark) {
            icon.classList.replace('fa-sun', 'fa-moon');
        } else {
            icon.classList.replace('fa-moon', 'fa-sun');
        }
        
        // Força o gráfico a se redesenhar com as cores novas
        atualizarGrafico(
            document.getElementById("cardEntregues").textContent,
            document.getElementById("cardPendentes").textContent
        );
    }

    function logout() { sessionStorage.clear(); window.location.href = "index.html"; }
  </script>
</head>

<body onload="carregarPagina()" class="bg-slate-100 min-h-screen font-sans">
  
    <div id="toast-container" class="fixed top-24 right-5 z-50 space-y-3"></div>
    
    <nav class="bg-white border-b border-gray-200 px-8 py-4 flex justify-between items-center sticky top-0 z-50 shadow-sm">
    <div class="flex items-center gap-3">
        <div class="bg-blue-600 p-2 rounded-lg text-white"><i class="fa-solid fa-box-open fa-lg"></i></div>
        <div>
            <h1 class="text-xl font-bold text-gray-800">Logística Pro</h1>
            <p class="text-xs text-gray-500 flex items-center gap-1"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Sistema Online</p>
        </div>
    </div>
    <div class="flex items-center gap-6">
      
      <a href="perfil.html" class="text-right hidden md:block p-2 rounded-lg hover:bg-gray-100 transition" title="Ver meu perfil">
          <p id="userName" class="text-sm font-bold text-gray-800"></p>
          <p id="userRole" class="text-xs text-blue-600 font-medium bg-blue-50 px-2 rounded-full w-fit ml-auto"></p>
      </a>
      
      <button onclick="toggleTheme()" class="text-gray-400 hover:text-blue-600 transition" title="Mudar tema">
          <i class="fa-solid fa-sun fa-xl" id="theme-icon"></i>
      </button>

      <button onclick="logout()" class="text-gray-400 hover:text-red-500 transition" title="Sair"><i class="fa-solid fa-right-from-bracket fa-xl"></i></button>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto p-8">
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="lg:col-span-1 space-y-4">
            <div onclick="aplicarFiltro('TODOS')" class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500 flex items-center justify-between transform hover:scale-105 transition duration-300 cursor-pointer">
                <div><p class="text-xs text-gray-500 font-bold uppercase tracking-wider">Ver Todos Pedidos</p><h3 class="text-3xl font-bold text-gray-800 mt-1" id="cardTotal">0</h3></div>
                <div class="bg-blue-100 p-4 rounded-full text-blue-600"><i class="fa-solid fa-clipboard-list fa-xl"></i></div>
            </div>
            
            <div onclick="aplicarFiltro('ENTREGUE')" class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500 flex items-center justify-between transform hover:scale-105 transition duration-300 cursor-pointer">
                <div><p class="text-xs text-gray-500 font-bold uppercase tracking-wider">Ver Entregues</p><h3 class="text-3xl font-bold text-gray-800 mt-1" id="cardEntregues">0</h3></div>
                <div class="bg-green-100 p-4 rounded-full text-green-600"><i class="fa-solid fa-check-double fa-xl"></i></div>
            </div>

            <div onclick="aplicarFiltro('ATIVOS')" class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-yellow-500 flex items-center justify-between transform hover:scale-105 transition duration-300 cursor-pointer">
                <div><p class="text-xs text-gray-500 font-bold uppercase tracking-wider">Ver Fila Ativa</p><h3 class="text-3xl font-bold text-gray-800 mt-1" id="cardPendentes">0</h3></div>
                <div class="bg-yellow-100 p-4 rounded-full text-yellow-600"><i class="fa-solid fa-hourglass-half fa-xl"></i></div>
            </div>
        </div>

        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h3 class="text-lg font-bold text-gray-700 mb-4">Visão Geral dos Pedidos</h3>
            <canvas id="graficoPedidos"></canvas> 
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-6 mb-8 flex gap-4 items-center border border-gray-100">
        <div class="bg-blue-50 p-3 rounded-full text-blue-600"><i class="fa-solid fa-plus"></i></div>
        <input type="text" id="novoCliente" placeholder="Nome do Cliente..." 
               class="flex-1 border-b-2 border-gray-200 px-4 py-2 focus:outline-none focus:border-blue-500 transition bg-transparent text-lg">
        <button onclick="criarPedido()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-bold transition shadow-md hover:shadow-lg flex items-center gap-2">
            <span>Criar Pedido</span> <i class="fa-solid fa-arrow-right"></i>
        </button>
        <a id="adminControls" href="logs.html" class="bg-slate-800 hover:bg-slate-700 text-white px-6 py-3 rounded-lg font-bold transition shadow-md hidden flex items-center gap-2">
             <i class="fa-solid fa-shield-halved"></i> Logs & Auditoria
        </a>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-8">
      <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
          <h2 id="tituloTabela" class="text-lg font-bold text-gray-700">Fila de Trabalho Ativa</h2>
          <span class="text-xs text-gray-400 uppercase font-bold bg-gray-100 px-2 py-1 rounded">Atualização em Tempo Real</span>
      </div>
      <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead class="text-gray-500 uppercase text-xs bg-gray-50">
              <tr>
                <th class="p-4">Rastreio</th>
                <th class="p-4">Cliente</th>
                <th class="p-4">Status</th>
                <th class="p-4">Data e Hora</th>
                <th class="p-4 text-center">Ações</th>
              </tr>
            </thead>
            <tbody id="tabelaPedidos"></tbody>
          </table>
      </div>
    </div>
  </div>
</body>
</html>